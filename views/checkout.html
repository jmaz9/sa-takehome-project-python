{% extends 'layouts/main.html' %}

{% block content %}
<div class="row justify-content-md-center">
  <div class="col-6">
    <div class="text-center mt-40">
      <h1>
        Checkout â€” Stripe Press
      </h1>
      <h5 class="text-secondary">
        {{ title }}
      </h5>
      <hr class="mt-40">
      <div class="mt-20 text-info">
        Total due: $<span class="amount" data-amount="{{ amount }}"></span>
      </div>
    </div>
    <div class="card box-shadow mt-40">
      <div class="card-body">
        <form id="payment-form">
          <div>
            <label for="email">Email address</label>
            <input type="email" class="form-control" id="email" name="email" placeholder="you@email.com">
          </div>

          <!-- Hidden fields to track the item and amount -->
          <input type="hidden" id="item" name="item" value="{{ item }}">
          <input type="hidden" id="amount" name="amount" value="{{ amount }}">

          <!-- Stripe Element for card input -->
          <div class="mt-20" id="card-element">
            <!-- Stripe's card input field will be inserted here -->
          </div>
          <div id="card-errors" role="alert" class="mt-10 text-danger"></div> <!-- Error messages will be displayed here -->

          <div class="mt-20">
            <button type="submit" class="btn btn-lg btn-block btn-primary">Pay $<span class="amount" data-amount="{{ amount }}"></span></button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Include Stripe.js and set up Stripe Elements -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Set up Stripe.js and Elements using your Stripe public key
    const stripe = Stripe('{{ publishable_key }}');
    const elements = stripe.elements();

    // Create an instance of the card Element and mount it to the #card-element div
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    // Handle form submission
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Get the amount from the hidden input field
        const amount = document.getElementById('amount').value;

        // Fetch the Payment Intent from the backend
        const { clientSecret } = await fetch('/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: parseInt(amount) }) // Ensure it's an integer in cents
        }).then((response) => response.json());

        // Confirm the card payment using Stripe.js
        const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement,
                billing_details: { email: document.getElementById('email').value },
            },
        });

        if (error) {
            document.getElementById('card-errors').textContent = error.message;
        } else {
            // Payment succeeded; redirect to success page with amount and paymentIntent.id
            const intentId = paymentIntent.id;
            window.location.href = `/success?amount=${amount}&payment_intent=${intentId}`;
        }
    });
</script>
{% endblock %}
